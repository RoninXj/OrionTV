# 弹幕功能故障排除指南

## 🚨 问题现象
弹幕显示"未找到弹幕"或弹幕不显示

## 🔍 问题分析

### 主要原因
1. **服务器地址未配置** - 最常见的问题
2. **网络连接问题** - 无法访问 InfinityTV 服务器
3. **API 接口问题** - 服务器弹幕 API 异常
4. **缓存问题** - 旧的错误缓存影响

## 🛠️ 解决步骤

### 步骤 1: 配置服务器地址
1. 打开 OrionTV 应用
2. 进入 **设置** 页面
3. 找到 **API 配置** 部分
4. 输入 InfinityTV 服务器地址
   - 格式示例: `http://192.168.1.100:3000`
   - 格式示例: `https://your-domain.com`
5. 点击 **保存** 按钮

### 步骤 2: 使用调试工具
在播放页面（开发模式下）：

1. **弹幕诊断** - 全面检查弹幕功能状态
   - 检查存储设置
   - 测试网络连接
   - 验证 API 调用

2. **测试API** - 直接测试弹幕数据获取
   - 使用当前视频信息测试
   - 查看详细的 API 响应

3. **清理缓存** - 清除可能的错误缓存
   - 删除所有弹幕缓存
   - 强制重新获取数据

### 步骤 3: 检查服务器状态
1. 确保 InfinityTV 服务器正在运行
2. 访问弹幕 API 端点测试：
   ```
   GET http://your-server/api/danmu-external?title=测试
   ```
3. 检查服务器日志是否有错误

### 步骤 4: 网络连接检查
1. 确保设备能访问 InfinityTV 服务器
2. 检查防火墙设置
3. 确认端口是否开放
4. 测试网络连通性

## 🔧 调试命令

### 在开发环境中
```javascript
// 在控制台中运行
DanmakuDebug.diagnose()           // 完整诊断
DanmakuDebug.checkStorageSettings() // 检查存储设置
DanmakuDebug.testDanmakuAPI('视频标题', '集数') // 测试 API
DanmakuDebug.clearCache()         // 清理缓存
```

### 手动设置测试服务器
```javascript
// 设置测试服务器地址
DanmakuDebug.setTestServerUrl('http://192.168.1.100:3000')
```

## 📋 常见错误信息

### "请先在 OrionTV 设置中配置服务器地址"
- **原因**: 未配置或配置错误的服务器地址
- **解决**: 按照步骤 1 正确配置服务器地址

### "网络请求失败" 或 "超时"
- **原因**: 网络连接问题或服务器不可访问
- **解决**: 检查网络连接和服务器状态

### "API 响应格式错误"
- **原因**: InfinityTV 服务器 API 返回异常数据
- **解决**: 检查服务器版本和 API 兼容性

### "未找到弹幕数据"
- **原因**: 该视频确实没有弹幕数据
- **解决**: 尝试其他视频或检查弹幕数据源

## 🎯 验证修复

### 成功标志
1. 控制台显示: `📍 使用 OrionTV 配置的服务器地址: http://...`
2. 控制台显示: `🎉 InfinityTV API 弹幕获取成功: X 条`
3. 弹幕在视频播放时正常显示
4. 弹幕配置面板显示正确的弹幕数量

### 测试用例
1. **基础测试**: 播放任意视频，检查是否有弹幕
2. **配置测试**: 调整弹幕设置，检查是否生效
3. **缓存测试**: 重新播放相同视频，检查缓存是否工作
4. **网络测试**: 断网重连后检查弹幕是否恢复

## 🚀 性能优化建议

1. **缓存策略**: 弹幕数据缓存 24 小时，减少重复请求
2. **网络优化**: 使用 30 秒超时，避免长时间等待
3. **错误处理**: 优雅降级，不影响视频播放
4. **用户体验**: 显示加载状态和错误提示

## 📞 获取帮助

如果以上步骤都无法解决问题：

1. **收集信息**:
   - 控制台完整日志
   - 服务器地址配置
   - 网络环境信息
   - 设备和系统版本

2. **检查文档**:
   - InfinityTV 服务器文档
   - OrionTV 项目 README
   - 弹幕集成文档

3. **社区支持**:
   - 提交 GitHub Issue
   - 查看已知问题列表
   - 参考类似问题的解决方案

## 🔄 更新日志

### v1.1.0 (最新)
- ✅ 修复存储键匹配问题 (`mytv_settings`)
- ✅ 添加完整的调试工具
- ✅ 改进错误处理和用户提示
- ✅ 优化网络请求和缓存机制

### v1.0.0
- ✅ 基础弹幕功能实现
- ✅ ArtPlayer 风格渲染
- ✅ 弹幕配置面板
- ✅ 缓存机制